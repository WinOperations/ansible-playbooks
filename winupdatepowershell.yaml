---
- name: Power on VM and perform Windows update via Powershell
  hosts: windows
  become: no
  gather_facts: no
  vars:
    ansible_ssh_user: ssh
    ansible_ssh_pass: W1n0per2024!
    ansible_shell_type: powershell
    ansible_shell_executable: powershell.exe

  tasks:
    - name: Power on the VM using PowerShell
      ansible.builtin.shell: |
        Start-VM -Name "01 - LAB - GAM"
      args:
        executable: powershell.exe

    - name: Wait for VM to become available
      ansible.builtin.wait_for:
        host: "{{ vm_ip }}"
        port: 5985
        timeout: 300

- name: Prepare and Update Windows VM via PowerShell
  hosts: windows_vm
  tasks:
    - name: Set TLS 1.2 as Security Protocol
      ansible.windows.win_powershell:
        command: '[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12'
        
    - name: Set Execution Policy to RemoteSigned
      ansible.windows.win_powershell:
        command: 'Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Force'

    - name: Set Execution Policy to Unrestricted
      ansible.windows.win_powershell:
        command: 'Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force'

    - name: Install PSWindowsUpdate Module
      ansible.windows.win_powershell:
        command: 'Install-Module -Name PSWindowsUpdate -Force -AllowClobber'

    - name: Add Microsoft Update Service
      ansible.windows.win_powershell:
        command: 'Add-WUServiceManager -MicrosoftUpdate -Force'

    - name: Run Windows Update via PowerShell
      ansible.windows.win_powershell:
        command: Install-WindowsUpdate -AcceptAll -AutoReboot
